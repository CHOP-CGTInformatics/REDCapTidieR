---
title: "Getting Started with REDCapTidieR"
output: rmarkdown::html_vignette
description: >
  Start here for an introduction on how to use REDCapTidieR in your data analysis.
vignette: >
  %\VignetteIndexEntry{Getting Started with REDCapTidieR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE}
library(httptest)

if (dir.exists("REDCapTidieR")) {
  # Make sure these match inst/misc/fake_credentials.csv
  redcap_uri <- "https://my.institution.edu/redcap/api/"
  token <- "123456789ABCDEF123456789ABCDEF04"
} else {
  redcap_uri <- Sys.getenv("REDCAP_URI")
  token <- Sys.getenv("SUPERHEROES_REDCAP_API")
}

# Make sure REDCapTidieR is attached so start_vignette() can find start-vignette.R
library(REDCapTidieR)

start_vignette("REDCapTidieR")
```

[REDCap](https://www.project-redcap.org/) is an electronic data capture software that is widely used in the academic research community. The [REDCapR](https://ouhscbbmc.github.io/REDCapR/) package streamlines calls to the REDCap API from an R environment. One of REDCapR's main uses is to import records from a REDCap project. This works well for simple projects, however becomes ugly when complex databases that include longitudinal structure and/or repeating instruments are involved.

The REDCapTidieR package aims to make the life of analysts who deal with complex REDCap databases easier. It builds upon **REDCapR** to make its output **tidier**. Instead of one large data frame that contains all the data from your project, you get to work with a set of tidy tibbles, one for each REDCap instrument.

## Case Study: The Superhero Database

Let's look at a REDCap database that has information about some 734 superheroes, derived from the [Superhero Database](https://www.superherodb.com/).

Here is a screenshot of the REDCap Record Status Dashboard of this database. It has two instruments, **Heroes Information** which captures "demographic" data about each individual superhero such as their name, gender, and alignment (good or evil), and **Super Hero Powers** which captures each one of the superpowers that a specific superhero possesses.

<center>

![REDCap Record Status Dashboard for the Superhero database](record-status-dash.png)

</center>

## Importing data from REDCap

To import data from REDCap, use the `read_redcap()` function. `read_redcap()` requires a REDCap database URI and a REDCap API token. *You need to have API access to the REDCap database to use REDCapTidieR. REDCapTidieR does not work with files exported from REDCap.* We use it here to import data from the Superheroes database. You can see that it returns a [tibble](https://tibble.tidyverse.org/) named `superheroes`. We use `rmarkdown::paged_table()` so you can explore this tibble.

```{r}
library(REDCapTidieR)
superheroes <- read_redcap(redcap_uri, token)

superheroes |>
  rmarkdown::paged_table()
```

You can see that the tibble that `read_redcap()` returned has only two rows. This may be surprising because you might expect more rows from a database with 734 superheroes. `read_redcap()` returns data in a special object that we call the **supertibble**. The supertibble contains, among other things, tibbles with the data and metadata derived from each instrument. We call these the **data tibbles** and **metadata tibbles**.

**Each row of the supertibble corresponds to one REDCap instrument**. The `redcap_form_name` and `redcap_form_label` columns identify which instrument the row relates to. The `redcap_data` column contains the data tibbles. The `redcap_metadata` column contains the metadata tibbles. Additional columns contain useful information about the data tibble, such as row and column counts, size in memory, and the percentage of missing values in the data.

## Exploring the contents of the supertibble

We designed the supertibble so you can explore it with the [RStudio Data Viewer](https://support.posit.co/hc/en-us/articles/205175388-Using-the-Data-Viewer-in-the-RStudio-IDE). You can click on the table icon in the Environment tab to view of the supertibble in the data viewer. At a glance you see an overview of the instruments in the REDCap project.

<center>

![Data Viewer showing the `superheroes` supertibble](https://raw.githubusercontent.com/CHOP-CGTInformatics/REDCapTidieR/main/images/vignettes/viewer-supertibble.gif){width=75%}

</center>

You can drill down into individual tables in the `redcap_data` and `redcap_metadata` columns. Note that in the `heroes_information` data tibble, each row represents a superhero, identified by their `record_id`.

<center>

![Data Viewer showing the `heroes_information` data tibble](https://raw.githubusercontent.com/CHOP-CGTInformatics/REDCapTidieR/main/images/vignettes/viewer-heroes-information.gif){width=75%}

</center>

In the `super_hero_powers` data tibble, each row represents a superpower of a specific hero. Each row is identified by the combination of `record_id` and `redcap_repeat_instance`. This difference in granularity is because in REDCap `super_hero_powers` was designated to be a **repeating** instrument whereas `heroes_information` was designated as a **nonrepeating** instrument.

<center>

![Data Viewer showing the `super_hero_powers` data tibble](https://raw.githubusercontent.com/CHOP-CGTInformatics/REDCapTidieR/main/images/vignettes/viewer-super-hero-powers.gif){width=75%}

</center>

You can also explore the metadata tibbles in the `redcap_metadata` column to find out about field labels, field types, and other field attributes.

<center>

![Data Viewer showing the `heroes_information` metadata tibble](https://raw.githubusercontent.com/CHOP-CGTInformatics/REDCapTidieR/main/images/vignettes/viewer-metadata.gif){width=75%}

</center>

## Extracting data tibbles from the supertibble

REDCapTidieR provides three different functions to extract data tibbles from a supertibble.

### Binding data tibbles into the environment

The `bind_tibbles()` function takes a supertibble and binds its data tibbles directly into the global environment. When you use `bind_tibbles()` while working interactively in the RStudio IDE, you will see data tibbles appear in the Environment pane.

<center>

![Demonstration of the `bind_tibbles` function](https://raw.githubusercontent.com/CHOP-CGTInformatics/REDCapTidieR/main/images/vignettes/bind-tibbles.gif){width=75%}

</center>

By default, `bind_tibbles()` extracts all data tibbles from the supertibble. With the `tbls` argument you can specify a subset of data tibbles that should be extracted. With the `environment` argument you can supply your own environment object to which the tibbles will be bound.

### Extracting a list of data tibbles

The `extract_tibbles()` function takes a supertibble and returns a named list of data tibbles. The default is to extract all data tibbles. We use `str` here to show the structure of the list returned by `extract_tibbles()`.

```{r}
superheroes_list <- superheroes |>
  extract_tibbles()

superheroes_list |>
  str(max.level = 1)
```

You can use [tidyselect selectors](https://tidyselect.r-lib.org/reference/language.html) to select specific data tibbles.

```{r}
superheroes |>
  extract_tibbles(ends_with("powers")) |>
  str(max.level = 1)
```

### Extracting a single data tibble

The `extract_tibble()` takes a supertibble and returns a single data tibble.

```{r}
superheroes |>
  extract_tibble("heroes_information") |>
  rmarkdown::paged_table()
```

### Memory considerations

You might wonder if it's memory inefficient to have both the supertibble and the extracted tibbles in your environment. Because of R's [copy-on-modify behavior](https://adv-r.hadley.nz/names-values.html#copy-on-modify) this extracting data tibbles actually uses very little additional memory. Here is the size of the `superheroes` supertibble.

```{r}
lobstr::obj_size(superheroes)
```

If we bind the data tibbles into the environment and then check the combined size of the supertibble *and* the two data tibbles we get the following:

```{r}
superheroes |>
  bind_tibbles()

lobstr::obj_size(superheroes, heroes_information, super_hero_powers)
```

The same is true if we use the `extract_tibble()` or `extract_tibbles()` functions:

```{r}
a <- superheroes |> extract_tibble("heroes_information")
b <- superheroes |> extract_tibbles()

lobstr::obj_size(superheroes, a, b)
```

## Adding variable labels with the labelled package

REDCapTidieR integrates with the [labelled](http://larmarange.github.io/labelled/) package to allow you to attach labels to variables in the supertibble. Variable labels can make data exploration easier. An increasing number of R packages support labelled data, including [ggplot](https://ggplot2.tidyverse.org/) (via [ggeasy](https://jonocarroll.github.io/ggeasy/)) and [gtsummary](https://www.danieldsjoberg.com/gtsummary/). The RStudio Data Viewer shows variable labels below variable names.

<center>

![Data Viewer showing part of a labelled supertibble](labelled-supertibble.png){width=75%}

</center>

The `make_labelled()` function takes a supertibble and returns a supertibble with variable labels applied to the variables of the supertibble as well as to the variables of all data and metadata tibbles in the `redcap_data` and `redcap_metadata` columns of the supertibble.

You can use the `labelled::look_for()` function to explore the variable labels of a tibble.

```{r}
superheroes |>
  make_labelled() |>
  bind_tibbles()

labelled::look_for(heroes_information)
```

Where did these labels come from? These labels are actually the REDCap **field labels** that prompt data entry in the REDCap instrument! REDCapTidieR places them into the `field_label` variable of the instrument's metadata tibble. Below you can see that the field labels of the REDCap instrument for `heroes_information` are the same as the labels above.

<center>

![REDCap data entry view of the `heroes_information` instrument](heroes-information-redcap-form.png){width=75%}

</center>

The label for `name` doesn't look quite right. Let's remove that trailing `:`. The `make_labelled()` function has a `format_labels` argument that you can use to preprocess labels before applying them to the variables.

```{r}
superheroes |>
  make_labelled(format_labels = ~gsub(":", "", .)) |>
  bind_tibbles()

labelled::look_for(heroes_information, "hero")
```

Removing trailing `:` characters is a fairly common operation, so REDCapTidieR provides a helper function that you can pass to the `format_labels` argument:

```{r}
fmt_strip_trailing_colon("Hero name:")
```

To find out about other helpers included with REDCapTidieR, see `` ?`format-helpers` ``.

The `format_labels` argument will also accept a multiple functions in a vector or list. You can use any function that takes a character vector and returns a modified character vector. `make_labelled()` will process the variable labels using these functions in the order they are supplied. In the following example, we remove the trailing colon with `fmt_strip_trailing_colon()` and then make the labels lower case with `base::tolower()`.

```{r}
superheroes |>
  make_labelled(
    format_labels = c(
      fmt_strip_trailing_colon, 
      base::tolower)
  ) |>
  bind_tibbles()

labelled::look_for(heroes_information)
```

```{r, include=FALSE}
end_vignette()
```
